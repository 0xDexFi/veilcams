#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# ─── Colors ──────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# ─── Banner ──────────────────────────────────────────────────────
show_banner() {
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════╗"
    echo "║                                               ║"
    echo "║   ██╗   ██╗███████╗██╗██╗      ██████╗ █████╗ ║"
    echo "║   ██║   ██║██╔════╝██║██║     ██╔════╝██╔══██╗║"
    echo "║   ██║   ██║█████╗  ██║██║     ██║     ███████║║"
    echo "║   ╚██╗ ██╔╝██╔══╝  ██║██║     ██║     ██╔══██║║"
    echo "║    ╚████╔╝ ███████╗██║███████╗╚██████╗██║  ██║║"
    echo "║     ╚═══╝  ╚══════╝╚═╝╚══════╝ ╚═════╝╚═╝  ╚═╝║"
    echo "║                                               ║"
    echo "║       Webcam Security Testing Framework       ║"
    echo "║                  v1.0.0                       ║"
    echo "╚═══════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# ─── Help ────────────────────────────────────────────────────────
show_help() {
    show_banner
    echo -e "${BOLD}Usage:${NC}"
    echo "  ./veilcams start              Start a scan (prompts for target)"
    echo "  ./veilcams start TARGETS=IP   Start a scan directly"
    echo "  ./veilcams stop               Stop all containers"
    echo "  ./veilcams logs               View real-time worker logs"
    echo "  ./veilcams query ID=<id>      Query workflow progress"
    echo "  ./veilcams build              Build containers"
    echo ""
    echo -e "${BOLD}Quick Start:${NC}"
    echo "  ./veilcams start"
    echo "  > 192.168.1.100               (enter target when prompted)"
    echo ""
    echo -e "${BOLD}Advanced:${NC}"
    echo "  ./veilcams start TARGETS=\"192.168.1.0/24\"     Scan entire subnet"
    echo "  ./veilcams start TARGETS=\"10.0.0.50;10.0.0.51\" Multiple hosts"
    echo "  ./veilcams start CONFIG=./configs/my-config.yaml Custom config"
    echo "  ./veilcams stop CLEAN=true                       Remove volumes too"
    echo ""
    echo -e "${CYAN}The tool automatically scans all camera ports, identifies vendors,${NC}"
    echo -e "${CYAN}tests default credentials, checks for CVEs, and generates a report.${NC}"
    echo ""
    echo -e "${YELLOW}WARNING: Only scan networks you own or have explicit authorization to test.${NC}"
}

# ─── Parse Args ──────────────────────────────────────────────────
parse_args() {
    for arg in "$@"; do
        case "$arg" in
            TARGETS=*)  TARGETS="${arg#TARGETS=}" ;;
            CONFIG=*)   CONFIG="${arg#CONFIG=}" ;;
            OUTPUT=*)   OUTPUT="${arg#OUTPUT=}" ;;
            ID=*)       WORKFLOW_ID="${arg#ID=}" ;;
            CLEAN=*)    CLEAN="${arg#CLEAN=}" ;;
            REBUILD=*)  REBUILD="${arg#REBUILD=}" ;;
            WAIT=*)     WAIT="${arg#WAIT=}" ;;
            PIPELINE_TESTING=*) PIPELINE_TESTING="${arg#PIPELINE_TESTING=}" ;;
        esac
    done
}

# ─── Ensure Containers ──────────────────────────────────────────
ensure_containers() {
    local rebuild_flag=""
    if [[ "${REBUILD:-}" == "true" ]]; then
        rebuild_flag="--build --no-cache"
        echo -e "${YELLOW}Forcing rebuild...${NC}"
    fi

    # Check if containers are running
    if ! docker compose ps --services --filter "status=running" 2>/dev/null | grep -q "temporal"; then
        echo -e "${CYAN}Starting containers...${NC}"
        docker compose up -d $rebuild_flag
        echo -e "${GREEN}Waiting for Temporal to be ready...${NC}"
        sleep 5

        local retries=0
        while ! docker compose exec -T temporal temporal operator namespace describe default >/dev/null 2>&1; do
            retries=$((retries + 1))
            if [[ $retries -gt 30 ]]; then
                echo -e "${RED}Temporal failed to start after 30 retries${NC}"
                exit 1
            fi
            sleep 2
        done
        echo -e "${GREEN}Temporal is ready.${NC}"
    fi
}

# ─── Commands ────────────────────────────────────────────────────

cmd_start() {
    show_banner

    # Interactive prompt if no TARGETS provided
    if [[ -z "${TARGETS:-}" ]]; then
        echo -e "${BOLD}Enter target IP or range to scan:${NC}"
        echo -e "${CYAN}  Examples:${NC}"
        echo -e "    192.168.1.100        (single camera)"
        echo -e "    192.168.1.0/24       (entire subnet)"
        echo -e "    10.0.0.50;10.0.0.51  (multiple hosts)"
        echo ""
        echo -ne "${GREEN}> ${NC}"
        read -r TARGETS

        if [[ -z "$TARGETS" ]]; then
            echo -e "${RED}Error: No target provided.${NC}"
            exit 1
        fi
    fi

    ensure_containers

    # Build CLI args
    local cli_args="TARGETS=$TARGETS WAIT=true"
    [[ -n "${CONFIG:-}" ]] && cli_args="$cli_args CONFIG=$CONFIG"
    [[ -n "${OUTPUT:-}" ]] && cli_args="$cli_args OUTPUT=$OUTPUT"
    [[ "${PIPELINE_TESTING:-}" == "true" ]] && cli_args="$cli_args PIPELINE_TESTING=true"

    echo ""
    echo -e "${GREEN}Scanning ${BOLD}${TARGETS}${NC}${GREEN} — all camera ports will be checked automatically.${NC}"
    echo -e "${CYAN}This will: discover open ports → identify cameras → test credentials → check CVEs → fuzz protocols${NC}"
    echo ""
    docker compose exec -T worker node dist/temporal/client.js $cli_args
}

cmd_stop() {
    echo -e "${CYAN}Stopping containers...${NC}"
    if [[ "${CLEAN:-}" == "true" ]]; then
        docker compose down -v
        echo -e "${GREEN}Stopped and cleaned all data.${NC}"
    else
        docker compose down
        echo -e "${GREEN}Stopped. Data preserved in volumes.${NC}"
    fi
}

cmd_logs() {
    if [[ -z "${WORKFLOW_ID:-}" ]]; then
        # Show worker logs
        docker compose logs -f worker
    else
        # Find workflow log file
        local log_file=""
        if [[ -f "./audit-logs/${WORKFLOW_ID}/workflow.log" ]]; then
            log_file="./audit-logs/${WORKFLOW_ID}/workflow.log"
        else
            log_file=$(find ./audit-logs -maxdepth 3 -path "*${WORKFLOW_ID}*/workflow.log" 2>/dev/null | head -1)
        fi

        if [[ -n "$log_file" ]]; then
            tail -f "$log_file"
        else
            echo -e "${YELLOW}Log file not found for ${WORKFLOW_ID}. Showing worker logs:${NC}"
            docker compose logs -f worker
        fi
    fi
}

cmd_query() {
    if [[ -z "${WORKFLOW_ID:-}" ]]; then
        echo -e "${RED}Error: ID is required${NC}"
        echo "Example: ./veilcams query ID=<workflow-id>"
        exit 1
    fi

    docker compose exec -T worker node dist/temporal/query.js "$WORKFLOW_ID"
}

cmd_build() {
    echo -e "${CYAN}Building containers...${NC}"
    docker compose build "${REBUILD:+--no-cache}"
    echo -e "${GREEN}Build complete.${NC}"
}

# ─── Main ────────────────────────────────────────────────────────

COMMAND="${1:-help}"
shift 2>/dev/null || true

parse_args "$@"

case "$COMMAND" in
    start)  cmd_start ;;
    stop)   cmd_stop ;;
    logs)   cmd_logs ;;
    query)  cmd_query ;;
    build)  cmd_build ;;
    help|--help|-h)  show_help ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        show_help
        exit 1
        ;;
esac
