import type { CveCheck, CveTestResult, FingerprintResult } from '../types/index.js';
import { httpGet } from '../utils/network.js';

export const axisChecks: CveCheck[] = [
  {
    cveId: 'CVE-2018-10660',
    vendor: 'axis',
    title: 'Axis Camera Shell Command Injection via param.cgi',
    severity: 'critical',
    description: 'Axis cameras allow authenticated users to inject arbitrary shell commands through the param.cgi interface. Unauthenticated exploitation is possible if combined with other vulnerabilities.',
    affectedModels: ['M10*', 'P13*', 'Q60*'],
    affectedFirmware: ['<8.40.1'],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      try {
        // Check if param.cgi is accessible
        const resp = await httpGet(
          `${baseUrl}/axis-cgi/param.cgi?action=list&group=root.Brand`,
          { timeout: 8000 }
        );

        const body = typeof resp.data === 'string' ? resp.data : '';
        const accessible = resp.status === 200 && body.includes('Brand');

        return {
          cveId: 'CVE-2018-10660',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Axis Camera Shell Command Injection',
          severity: 'critical',
          vulnerable: accessible,
          evidence: accessible
            ? `param.cgi accessible without auth — device info exposed (HTTP ${resp.status}): ${body.substring(0, 200)}`
            : `param.cgi properly restricted (HTTP ${resp.status})`,
          poc: `curl "${baseUrl}/axis-cgi/param.cgi?action=list&group=root.Brand"`,
          remediation: 'Update firmware to version 8.40.1 or later.',
          timestamp,
        };
      } catch (error) {
        return {
          cveId: 'CVE-2018-10660',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Axis Camera Shell Command Injection',
          severity: 'critical',
          vulnerable: false,
          evidence: `Check failed: ${(error as Error).message}`,
          poc: '',
          remediation: '',
          timestamp,
        };
      }
    },
  },

  {
    cveId: 'CVE-2018-10661',
    vendor: 'axis',
    title: 'Axis Camera Authentication Bypass via .srv',
    severity: 'critical',
    description: 'The .srv functionality in Axis cameras allows bypassing authentication restrictions by abusing the URI path handling.',
    affectedModels: [],
    affectedFirmware: ['<8.40.1'],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      try {
        // Try .srv auth bypass
        const resp = await httpGet(
          `${baseUrl}/index.html/x.srv?action=list`,
          { timeout: 8000 }
        );

        const body = typeof resp.data === 'string' ? resp.data : '';
        const vulnerable = resp.status === 200 && body.length > 50;

        return {
          cveId: 'CVE-2018-10661',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Axis Authentication Bypass via .srv',
          severity: 'critical',
          vulnerable,
          evidence: vulnerable
            ? `Auth bypass via .srv path succeeded — page content returned (HTTP ${resp.status}, ${body.length} bytes)`
            : `Auth bypass not effective (HTTP ${resp.status})`,
          poc: `curl "${baseUrl}/index.html/x.srv?action=list"`,
          remediation: 'Update firmware to version 8.40.1 or later.',
          timestamp,
        };
      } catch (error) {
        return {
          cveId: 'CVE-2018-10661',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Axis Authentication Bypass via .srv',
          severity: 'critical',
          vulnerable: false,
          evidence: `Check failed: ${(error as Error).message}`,
          poc: '',
          remediation: '',
          timestamp,
        };
      }
    },
  },
];
