import type { CveCheck, CveTestResult, FingerprintResult } from '../types/index.js';
import { httpGet } from '../utils/network.js';
import { CONFIG_DISCLOSURE_PATHS } from '../constants.js';

export const genericChecks: CveCheck[] = [
  {
    cveId: 'GENERIC-001',
    vendor: 'generic',
    title: 'Unauthenticated RTSP Stream Access',
    severity: 'high',
    description: 'Camera allows RTSP stream access without authentication, exposing live video feeds to any network user.',
    affectedModels: [],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const timestamp = new Date().toISOString();

      if (!target.protocols.includes('rtsp')) {
        return {
          cveId: 'GENERIC-001',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Unauthenticated RTSP Stream Access',
          severity: 'high',
          vulnerable: false,
          evidence: 'RTSP not detected on this host',
          poc: '',
          remediation: '',
          timestamp,
        };
      }

      const { rtspDescribe } = await import('../utils/network.js');
      const { RTSP_PATHS } = await import('../constants.js');

      const paths = [
        ...(RTSP_PATHS[target.vendor] || []),
        ...RTSP_PATHS.unknown,
      ];
      const uniquePaths = [...new Set(paths)];
      const rtspPort = 554;

      for (const streamPath of uniquePaths.slice(0, 10)) {
        try {
          const result = await rtspDescribe(target.ip, rtspPort, streamPath, undefined, 5000);
          if (result.statusCode === 200) {
            return {
              cveId: 'GENERIC-001',
              ip: target.ip,
              port: rtspPort,
              vendor: target.vendor,
              title: 'Unauthenticated RTSP Stream Access',
              severity: 'high',
              vulnerable: true,
              evidence: `RTSP stream accessible without auth at path: ${streamPath} (RTSP ${result.statusCode})`,
              poc: `ffplay rtsp://${target.ip}:${rtspPort}${streamPath}`,
              remediation: 'Enable RTSP authentication. Change default credentials and require authentication for all stream access.',
              timestamp,
            };
          }
        } catch { /* path not accessible */ }
      }

      return {
        cveId: 'GENERIC-001',
        ip: target.ip,
        port: target.port,
        vendor: target.vendor,
        title: 'Unauthenticated RTSP Stream Access',
        severity: 'high',
        vulnerable: false,
        evidence: 'All tested RTSP paths require authentication',
        poc: '',
        remediation: '',
        timestamp,
      };
    },
  },

  {
    cveId: 'GENERIC-002',
    vendor: 'generic',
    title: 'Configuration File Disclosure',
    severity: 'high',
    description: 'Camera web interface exposes configuration files containing sensitive information such as credentials, network settings, or internal paths.',
    affectedModels: [],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();
      const exposedPaths: string[] = [];

      for (const configPath of CONFIG_DISCLOSURE_PATHS) {
        try {
          const resp = await httpGet(`${baseUrl}${configPath}`, { timeout: 5000 });
          const body = typeof resp.data === 'string' ? resp.data : '';

          if (
            resp.status === 200 &&
            body.length > 20 &&
            !body.includes('<!DOCTYPE') &&
            !body.includes('<html')
          ) {
            exposedPaths.push(configPath);
          }
        } catch { /* path not accessible */ }
      }

      const vulnerable = exposedPaths.length > 0;
      return {
        cveId: 'GENERIC-002',
        ip: target.ip,
        port: target.port,
        vendor: target.vendor,
        title: 'Configuration File Disclosure',
        severity: 'high',
        vulnerable,
        evidence: vulnerable
          ? `${exposedPaths.length} config file(s) exposed: ${exposedPaths.join(', ')}`
          : 'No configuration files exposed',
        poc: vulnerable
          ? exposedPaths.map((p) => `curl "${baseUrl}${p}"`).join('\n')
          : '',
        remediation: 'Restrict access to configuration endpoints. Ensure all sensitive paths require authentication.',
        timestamp,
      };
    },
  },

  {
    cveId: 'GENERIC-003',
    vendor: 'generic',
    title: 'Unauthenticated Snapshot Access',
    severity: 'medium',
    description: 'Camera allows capturing still images (snapshots) without any authentication.',
    affectedModels: [],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const { SNAPSHOT_ENDPOINTS } = await import('../constants.js');
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      const endpoints = [
        ...(SNAPSHOT_ENDPOINTS[target.vendor] || []),
        ...SNAPSHOT_ENDPOINTS.unknown,
      ];
      const uniqueEndpoints = [...new Set(endpoints)];

      for (const endpoint of uniqueEndpoints) {
        try {
          const resp = await httpGet(`${baseUrl}${endpoint}`, { timeout: 5000 });
          const contentType = (resp.headers as Record<string, string>)['content-type'] || '';
          const isImage = contentType.includes('image/') || contentType.includes('octet-stream');

          if (resp.status === 200 && isImage) {
            return {
              cveId: 'GENERIC-003',
              ip: target.ip,
              port: target.port,
              vendor: target.vendor,
              title: 'Unauthenticated Snapshot Access',
              severity: 'medium',
              vulnerable: true,
              evidence: `Snapshot accessible without auth at ${endpoint} (HTTP ${resp.status}, Content-Type: ${contentType})`,
              poc: `curl -o snapshot.jpg "${baseUrl}${endpoint}"`,
              remediation: 'Enable authentication for snapshot endpoints.',
              timestamp,
            };
          }
        } catch { /* endpoint not accessible */ }
      }

      return {
        cveId: 'GENERIC-003',
        ip: target.ip,
        port: target.port,
        vendor: target.vendor,
        title: 'Unauthenticated Snapshot Access',
        severity: 'medium',
        vulnerable: false,
        evidence: 'All snapshot endpoints require authentication',
        poc: '',
        remediation: '',
        timestamp,
      };
    },
  },

  {
    cveId: 'GENERIC-004',
    vendor: 'generic',
    title: 'Web Interface Directory Traversal',
    severity: 'high',
    description: 'Camera web interface is vulnerable to directory traversal, allowing access to files outside the web root.',
    affectedModels: [],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      const traversalPaths = [
        '/..%2f..%2f..%2f..%2fetc%2fpasswd',
        '/cgi-bin/..%2f..%2f..%2f..%2fetc%2fpasswd',
        '/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd',
        '/....//....//....//etc/passwd',
      ];

      for (const traversal of traversalPaths) {
        try {
          const resp = await httpGet(`${baseUrl}${traversal}`, {
            timeout: 5000,
            followRedirects: false,
          });
          const body = typeof resp.data === 'string' ? resp.data : '';

          if (resp.status === 200 && (body.includes('root:') || body.includes('/bin/'))) {
            return {
              cveId: 'GENERIC-004',
              ip: target.ip,
              port: target.port,
              vendor: target.vendor,
              title: 'Web Interface Directory Traversal',
              severity: 'high',
              vulnerable: true,
              evidence: `Directory traversal successful via ${traversal} â€” /etc/passwd contents returned`,
              poc: `curl "${baseUrl}${traversal}"`,
              remediation: 'Update firmware. Ensure web server properly sanitizes path input.',
              timestamp,
            };
          }
        } catch { /* path not accessible */ }
      }

      return {
        cveId: 'GENERIC-004',
        ip: target.ip,
        port: target.port,
        vendor: target.vendor,
        title: 'Web Interface Directory Traversal',
        severity: 'high',
        vulnerable: false,
        evidence: 'No directory traversal vectors found',
        poc: '',
        remediation: '',
        timestamp,
      };
    },
  },

  {
    cveId: 'GENERIC-005',
    vendor: 'generic',
    title: 'Missing or Weak HTTP Security Headers',
    severity: 'info',
    description: 'Camera web interface is missing important security headers (HSTS, X-Frame-Options, CSP), making it susceptible to clickjacking and other client-side attacks.',
    affectedModels: [],
    affectedFirmware: [],
    check: async (target: FingerprintResult): Promise<CveTestResult> => {
      const scheme = target.protocols.includes('https') ? 'https' : 'http';
      const baseUrl = `${scheme}://${target.ip}:${target.port}`;
      const timestamp = new Date().toISOString();

      try {
        const resp = await httpGet(baseUrl, { timeout: 8000 });
        const headers = resp.headers as Record<string, string>;
        const missing: string[] = [];

        if (!headers['strict-transport-security']) missing.push('Strict-Transport-Security');
        if (!headers['x-frame-options']) missing.push('X-Frame-Options');
        if (!headers['x-content-type-options']) missing.push('X-Content-Type-Options');
        if (!headers['content-security-policy']) missing.push('Content-Security-Policy');
        if (!headers['x-xss-protection']) missing.push('X-XSS-Protection');

        const vulnerable = missing.length >= 3;
        return {
          cveId: 'GENERIC-005',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Missing or Weak HTTP Security Headers',
          severity: 'info',
          vulnerable,
          evidence: vulnerable
            ? `Missing security headers: ${missing.join(', ')}`
            : `Security headers present (${5 - missing.length}/5)`,
          poc: `curl -I "${baseUrl}"`,
          remediation: 'Configure the camera web server to send security headers. If firmware does not support this, place a reverse proxy in front.',
          timestamp,
        };
      } catch (error) {
        return {
          cveId: 'GENERIC-005',
          ip: target.ip,
          port: target.port,
          vendor: target.vendor,
          title: 'Missing or Weak HTTP Security Headers',
          severity: 'info',
          vulnerable: false,
          evidence: `Check failed: ${(error as Error).message}`,
          poc: '',
          remediation: '',
          timestamp,
        };
      }
    },
  },
];
